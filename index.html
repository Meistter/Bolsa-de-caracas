<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolsa de Valores de Caracas - Tracking en Vivo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ... (Estilos anteriores se mantienen igual) ... */
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --green: #22c55e; --red: #ef4444; --text: #f8fafc; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        nav { background: #1e293b; padding: 10px 20px; display: flex; gap: 15px; border-bottom: 1px solid #334155; align-items: center; z-index: 100; }
        nav button { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        nav button.active { background: var(--accent); color: var(--bg); }
        #view-all, #view-single { flex: 1; overflow-y: auto; width: 100%; }
        #view-single { display: none; overflow: hidden; }
        #dashboard { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; max-width: 1400px; margin: 0 auto; padding: 20px; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #334155; height: 300px; display: flex; flex-direction: column; }
        .company-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .logo { width: 32px; height: 32px; border-radius: 4px; background: white; object-fit: contain; }
        .card-chart-wrapper { flex: 1; position: relative; min-height: 140px; }
        .single-container { display: flex; height: 100%; width: 100%; }
        .sidebar { width: 300px; background: #0b1120; border-right: 1px solid #334155; overflow-y: auto; }
        .sidebar-item { padding: 12px; border-bottom: 1px solid #1e293b; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .sidebar-item.active { border-left: 4px solid var(--accent); background: #1e293b; }
        .main-chart-area { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; }
        .big-chart-container { background: #1e293b; border-radius: 15px; padding: 20px; height: 380px; position: relative; margin-bottom: 20px; }
        .range-selector { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .range-btn { background: #0f172a; border: 1px solid #334155; color: #94a3b8; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; transition: 0.2s; }
        .range-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: bold; }
        .price { font-size: 2rem; font-weight: bold; margin: 5px 0; }
        .variation { font-size: 1rem; font-weight: 500; }
        .up { color: var(--green); }
        .down { color: var(--red); }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .stat-box { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; }
        .stat-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .stat-val { font-size: 0.95rem; font-weight: bold; }
    </style>
</head>
<body>

    <nav>
        <button id="btn-all" class="active" onclick="switchView('all')">Dashboard General</button>
        <button id="btn-single" onclick="switchView('single')">Gráfico Individual</button>
        <div id="status-text" style="margin-left: auto; font-size: 0.8rem; color: #94a3b8;">Sincronizando...</div>
    </nav>

    <div id="view-all"><div id="dashboard"></div></div>

    <div id="view-single">
        <div class="single-container">
            <div class="sidebar" id="sidebar-list"></div>
            <div class="main-chart-area">
                <div id="single-header" style="display:flex; justify-content:space-between; align-items:end; margin-bottom:10px;">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <img id="single-logo" class="logo" style="width:48px; height:48px;">
                        <div>
                            <h1 id="single-title" style="margin:0; font-size:1.4rem;">Empresa</h1>
                            <div id="single-symbol" style="color:var(--accent); font-weight:bold; font-size:0.9rem;">SYMBOL</div>
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div class="price" id="single-price">0.00</div>
                        <div id="single-var" class="variation">0.00 (0%)</div>
                    </div>
                </div>

                <div class="range-selector">
                    <button class="range-btn active" onclick="setRange(1, this)">Hoy</button>
                    <button class="range-btn" onclick="setRange(3, this)">3 Días</button>
                    <button class="range-btn" onclick="setRange(7, this)">7 Días</button>
                    <button class="range-btn" onclick="setRange(15, this)">15 Días</button>
                    <button class="range-btn" onclick="setRange(30, this)">30 Días</button>
                </div>

                <div class="big-chart-container"><canvas id="main-large-chart"></canvas></div>
                <div id="single-stats" class="stats-row"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api/bolsa';
        const UPDATE_INTERVAL = 300000; 
        let marketData = [];
        const charts = {}; 
        let mainChart = null; 
        let selectedSymbol = null;
        let currentRange = 1;

        async function fetchData() {
            try {
                const response = await fetch(`${API_BASE}/actual`);
                marketData = await response.json();
                document.getElementById('status-text').innerText = `Última Sincronización: ${new Date().toLocaleTimeString()}`;
                
                updateGeneralView();
                updateSidebar();
                
                // Las miniaturas siempre muestran solo "Hoy" para ahorrar recursos
                marketData.forEach(item => loadHistory(item.symbol, 1, false));
                
                if (selectedSymbol) {
                    updateIndividualView();
                    loadHistory(selectedSymbol, currentRange, true);
                }
            } catch (error) { 
                document.getElementById('status-text').innerText = "Servidor Desconectado"; 
            }
        }

        async function setRange(days, btn) {
            currentRange = days;
            document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(selectedSymbol) await loadHistory(selectedSymbol, currentRange, true);
        }

        async function loadHistory(symbol, days, isLarge) {
            try {
                const response = await fetch(`${API_BASE}/historial/${symbol}/${days}`);
                const history = await response.json();
                
                const chart = isLarge ? mainChart : charts[symbol];
                if (chart && history.length > 0) {
                    // Lógica de etiquetas: Si el rango es grande, mostramos menos etiquetas para que no se amontonen
                    chart.data.labels = history.map((h, index) => {
                        const datePart = h.fecha_registro.split(' ')[0].substring(5); // mm-dd
                        const timePart = h.hora.substring(0, 5); // hh:mm
                        
                        if (!isLarge) return h.hora;
                        
                        // Si son 30 días, mostramos la fecha cada 12 registros para limpiar el eje X
                        if (days >= 15) {
                            return index % 12 === 0 ? `${datePart} ${timePart}` : '';
                        }
                        return days > 1 ? `${datePart} ${timePart}` : h.hora;
                    });

                    chart.data.datasets[0].data = history.map(h => h.precio);
                    
                    const last = history[history.length - 1];
                    const isUp = parseFloat(last.var_abs) >= 0;
                    chart.data.datasets[0].borderColor = isUp ? '#22c55e' : '#ef4444';
                    chart.data.datasets[0].backgroundColor = isUp ? 'rgba(34, 197, 148, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                    
                    chart.update(isLarge ? 'active' : 'none');
                }
            } catch (e) { console.error("Error historial:", e); }
        }

        function switchView(view) {
            document.getElementById('view-all').style.display = view === 'all' ? 'block' : 'none';
            document.getElementById('view-single').style.display = view === 'single' ? 'flex' : 'none';
            document.getElementById('btn-all').classList.toggle('active', view === 'all');
            document.getElementById('btn-single').classList.toggle('active', view === 'single');
            if (view === 'single' && !selectedSymbol && marketData.length > 0) selectCompany(marketData[0].symbol);
        }

        function updateGeneralView() {
            const container = document.getElementById('dashboard');
            marketData.forEach(item => {
                const id = item.symbol;
                if (!document.getElementById(`container-${id}`)) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.id = `container-${id}`;
                    card.innerHTML = `
                        <div class="company-header">
                            <img src="${item.icon}" class="logo" onerror="this.src='https://via.placeholder.com/32'">
                            <div>
                                <div style="color:var(--accent); font-weight:bold; font-size:0.8rem">${id}</div>
                                <div style="font-size:0.75rem; color:#94a3b8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:180px;">${item.nombre}</div>
                            </div>
                        </div>
                        <div class="price" id="price-${id}" style="font-size:1.4rem">0</div>
                        <div id="var-${id}" style="font-size:0.8rem; margin-bottom:10px;">0</div>
                        <div class="card-chart-wrapper"><canvas id="chart-${id}"></canvas></div>
                    `;
                    container.appendChild(card);
                    initChart(`chart-${id}`, id, false);
                }
                updateUIElements(item, `price-${id}`, `var-${id}`);
            });
        }

        function updateSidebar() {
            const sidebar = document.getElementById('sidebar-list');
            if (sidebar.children.length > 0) return;
            marketData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'sidebar-item';
                div.id = `side-${item.symbol}`;
                div.innerHTML = `<img src="${item.icon}" class="logo" style="width:24px; height:24px;"> <span>${item.symbol}</span>`;
                div.onclick = () => selectCompany(item.symbol);
                sidebar.appendChild(div);
            });
        }

        async function selectCompany(symbol) {
            selectedSymbol = symbol;
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            if(document.getElementById(`side-${symbol}`)) document.getElementById(`side-${symbol}`).classList.add('active');
            if (mainChart) mainChart.destroy();
            initChart('main-large-chart', symbol, true);
            updateIndividualView();
            await loadHistory(symbol, currentRange, true);
        }

        function updateIndividualView() {
            const item = marketData.find(c => c.symbol === selectedSymbol);
            if (!item) return;
            document.getElementById('single-logo').src = item.icon;
            document.getElementById('single-title').innerText = item.nombre;
            document.getElementById('single-symbol').innerText = item.symbol;
            updateUIElements(item, 'single-price', 'single-var');

            document.getElementById('single-stats').innerHTML = `
                <div class="stat-box"><span class="stat-label">Volumen</span><span class="stat-val">${item.volumen}</span></div>
                <div class="stat-box"><span class="stat-label">Monto Efectivo</span><span class="stat-val">${parseFloat(item.monto_efectivo).toLocaleString('es-VE')} VES</span></div>
                <div class="stat-box"><span class="stat-label">Var. Absoluta</span><span class="stat-val">${item.var_abs}</span></div>
                <div class="stat-box"><span class="stat-label">Var. Relativa</span><span class="stat-val">${item.var_rel}%</span></div>
                <div class="stat-box"><span class="stat-label">Último Registro</span><span class="stat-val">${item.hora}</span></div>
            `;
        }

        function updateUIElements(item, priceId, varId) {
            const price = parseFloat(item.precio);
            const varAbs = parseFloat(item.var_abs);
            const isUp = varAbs >= 0;
            const colorClass = isUp ? 'up' : 'down';
            const pEl = document.getElementById(priceId);
            if (pEl) { pEl.innerText = price.toLocaleString('es-VE', {minimumFractionDigits:2}); pEl.className = `price ${colorClass}`; }
            const vEl = document.getElementById(varId);
            if (vEl) { vEl.innerText = `${isUp ? '▲' : '▼'} ${item.var_abs} (${item.var_rel}%)`; vEl.className = `variation ${colorClass}`; }
        }

        function initChart(canvasId, storageId, isLarge) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const config = {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderWidth: 2, tension: 0.2, fill: true, pointRadius: isLarge ? 1 : 0, pointHitRadius: 10 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { display: isLarge, grid: { display: false }, ticks: { color: '#64748b', font: {size: 9}, maxRotation: 0, autoSkip: false } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', font: { size: 10 } } }
                    },
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }
                }
            };
            if (isLarge) mainChart = new Chart(ctx, config);
            else charts[storageId] = new Chart(ctx, config);
        }

        setInterval(fetchData, UPDATE_INTERVAL);
        fetchData();
    </script>
</body>
</html>